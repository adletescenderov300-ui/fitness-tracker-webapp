<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üèãÔ∏è Fitness Tracker Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #0088cc;
            --primary-dark: #006ba3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --bg: #ffffff;
            --card-bg: #f8f9fa;
            --text: #000000;
            --text-secondary: #6c757d;
            --border: #dee2e6;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--tg-theme-bg-color, var(--bg));
            color: var(--tg-theme-text-color, var(--text));
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--tg-theme-button-color, var(--primary)), var(--primary-dark));
            color: white;
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,136,204,0.3);
        }

        .stat-number { font-size: 24px; font-weight: bold; margin-bottom: 4px; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: var(--tg-theme-button-color, var(--primary));
            color: white;
        }

        .tab-btn:active { transform: scale(0.98); }

        .tab { display: none; }
        .tab.active { display: block; }

        /* –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ */
        .workout-form {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,136,204,0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 8px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tg-theme-button-color, var(--primary)), var(--primary-dark));
            color: white;
        }

        .btn-primary:active { transform: scale(0.98); }

        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { 
            background: var(--text-secondary); 
            color: white; 
            opacity: 0.8;
        }

        .exercise-item {
            background: white;
            padding: 20px;
            margin: 12px 0;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-info h4 { margin-bottom: 8px; color: var(--primary); }
        .exercise-stats { 
            color: var(--text-secondary); 
            font-size: 14px;
            display: flex;
            gap: 16px;
        }

        .current-workout-total {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            font-size: 18px;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .workout-card {
            background: white;
            padding: 20px;
            margin: 12px 0;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .workout-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .workout-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f0f8ff, white);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .workout-date { font-weight: bold; font-size: 16px; }
        .workout-volume { 
            background: var(--success); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 14px;
        }

        .workout-notes { 
            color: var(--text-secondary); 
            font-style: italic;
            margin-top: 8px;
        }

        .workout-details {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .pr-item {
            background: white;
            padding: 20px;
            margin: 12px 0;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pr-badge {
            background: linear-gradient(135deg, var(--warning), #ffca2c);
            color: #856404;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up { animation: fadeInUp 0.4s ease-out; }

        /* Telegram MainButton */
        #customMainButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
        }

        @media (max-width: 600px) {
            .container { padding: 16px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ —Å –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
        <div class="header">
            <h1>üèãÔ∏è Fitness Tracker Pro</h1>
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number" id="totalWorkouts">0</div>
                    <div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalVolume">0</div>
                    <div class="stat-label">–û–±—â–∏–π –æ–±—ä—ë–º, –∫–≥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestPR">0</div>
                    <div class="stat-label">–õ—É—á—à–∏–π –ü–†, –∫–≥</div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('new')">‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
            <button class="tab-btn" onclick="showTab('current')">üìù –¢–µ–∫—É—â–∞—è</button>
            <button class="tab-btn" onclick="showTab('history')">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="tab-btn" onclick="showTab('stats')">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>

        <!-- –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
        <div id="new" class="tab active fade-in-up">
            <div class="workout-form">
                <div class="form-group">
                    <input type="text" id="workoutName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ì—Ä—É–¥—å + –¢—Ä–∏—Ü–µ–ø—Å')">
                </div>
                <div class="form-group">
                    <input type="text" id="workoutPlace" placeholder="–ú–µ—Å—Ç–æ (–∑–∞–ª, –¥–æ–º, —É–ª–∏—Ü–∞)">
                </div>
                <div class="form-row">
                    <input type="text" id="exerciseName" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
                    <select id="exerciseCategory">
                        <option value="üí™ –ì—Ä—É–¥—å">üí™ –ì—Ä—É–¥—å</option>
                        <option value="üîô –°–ø–∏–Ω–∞">üîô –°–ø–∏–Ω–∞</option>
                        <option value="ü¶µ –ù–æ–≥–∏">ü¶µ –ù–æ–≥–∏</option>
                        <option value="üíÄ –†—É–∫–∏">üíÄ –†—É–∫–∏</option>
                        <option value="üî∫ –ü–ª–µ—á–∏">üî∫ –ü–ª–µ—á–∏</option>
                        <option value="‚úä –ü—Ä–µ—Å—Å">‚úä –ü—Ä–µ—Å—Å</option>
                        <option value="üèÉ –ö–∞—Ä–¥–∏–æ">üèÉ –ö–∞—Ä–¥–∏–æ</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="number" id="weight" placeholder="–í–µ—Å, –∫–≥" step="0.1" min="0">
                    <input type="number" id="reps" placeholder="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è" min="1">
                </div>
                <input type="number" id="sets" placeholder="–ü–æ–¥—Ö–æ–¥–æ–≤" min="1">
                <textarea id="exerciseNotes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" rows="2"></textarea>
                <button class="btn btn-primary" onclick="addExerciseToWorkout()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>
            <div id="workoutExercises"></div>
            <div id="workoutTotal" style="display:none;" class="current-workout-total">
                –û–±—â–∏–π –æ–±—ä—ë–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: <span id="totalVolumeNum">0</span> –∫–≥
            </div>
            <button class="btn btn-success" id="saveWorkoutBtn" onclick="saveCurrentWorkout()" style="display:none;">
                üíæ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
            </button>
        </div>

        <!-- –¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
        <div id="current" class="tab">
            <div id="currentWorkoutView" style="display:none;">
                <div class="workout-form">
                    <h3 id="currentWorkoutTitle"></h3>
                    <div id="currentWorkoutExercises"></div>
                    <button class="btn btn-primary" onclick="editCurrentWorkout()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-success" onclick="finalizeCurrentWorkout()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="deleteCurrentWorkout()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            <div id="noCurrentWorkout" style="text-align:center; padding:40px; color:var(--text-secondary);">
                <p>üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</p>
                <p>–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ "‚ûï –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞"</p>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div id="history" class="tab">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="loadMoreHistory()">üìÑ –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
                <button class="btn btn-secondary" onclick="clearHistoryConfirm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
            <div id="workoutHistory"></div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="stats" class="tab">
            <div id="personalRecords"></div>
            <div style="margin-top:30px;">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                <div id="categoryStats"></div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
        let currentWorkout = JSON.parse(localStorage.getItem('currentWorkout') || 'null');
        let prs = JSON.parse(localStorage.getItem('prs') || '{}');
        let historyOffset = 0;
        let editingWorkout = false;

        // –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram
        tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É').show().onClick(saveCurrentWorkout);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initApp();

        function initApp() {
            updateGlobalStats();
            loadCurrentWorkout();
            updateHistory();
            updateStats();
            checkCurrentWorkoutTab();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'current') checkCurrentWorkoutTab();
            if (tabName === 'history') updateHistory();
            if (tabName === 'stats') updateStats();
        }

        function updateGlobalStats() {
            const totalWorkouts = workouts.length;
            const totalVolume = workouts.reduce((sum, w) => sum + w.totalVolume, 0);
            const bestPR = Math.max(...Object.values(prs).map(p => p.weight || 0), 0);
            
            document.getElementById('totalWorkouts').textContent = totalWorkouts;
            document.getElementById('totalVolume').textContent = Math.round(totalVolume).toLocaleString();
            document.getElementById('bestPR').textContent = bestPR.toFixed(1);
        }

        let tempWorkout = [];
        function addExerciseToWorkout() {
            const exercise = {
                name: document.getElementById('exerciseName').value.trim(),
                category: document.getElementById('exerciseCategory').value,
                weight: parseFloat(document.getElementById('weight').value) || 0,
                reps: parseInt(document.getElementById('reps').value) || 0,
                sets: parseInt(document.getElementById('sets').value) || 0,
                notes: document.getElementById('exerciseNotes').value.trim(),
                volume: 0,
                id: Date.now()
            };

            if (!exercise.name || !exercise.weight || !exercise.reps || !exercise.sets) {
                tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!');
                return;
            }

            exercise.volume = exercise.weight * exercise.reps * exercise.sets;
            tempWorkout.push(exercise);
            
            updatePR(exercise);
            updateWorkoutExercises();
            clearExerciseForm();
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            if (!currentWorkout) {
                currentWorkout = {
                    name: document.getElementById('workoutName').value || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
                    place: document.getElementById('workoutPlace').value || '',
                    exercises: [],
                    totalVolume: 0,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('currentWorkout', JSON.stringify(currentWorkout));
            }
        }

        function updateWorkoutExercises() {
            const container = document.getElementById('workoutExercises');
            const totalVolume = tempWorkout.reduce((sum, ex) => sum + ex.volume, 0);
            
            container.innerHTML = tempWorkout.map(ex => `
                <div class="exercise-item">
                    <div>
                        <h4>${ex.category} - ${ex.name}</h4>
                        <div class="exercise-stats">
                            <span>‚öñÔ∏è ${ex.weight}–∫–≥</span>
                            <span>üî¢ ${ex.reps}√ó${ex.sets}</span>
                            <span>üìä ${Math.round(ex.volume)}–∫–≥</span>
                            ${ex.notes ? `<span>üìù ${ex.notes.slice(0,30)}${ex.notes.length>30?'...':''}</span>` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" style="width:40px;height:40px;font-size:14px;padding:8px;" onclick="removeExerciseFromWorkout(${ex.id})">√ó</button>
                    </div>
                </div>
            `).join('') + `
                <div style="text-align:center; padding:20px; color:var(--text-secondary);">
                    –í—Å–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${tempWorkout.length} | –û–±—â–∏–π –æ–±—ä—ë–º: <strong>${Math.round(totalVolume)} –∫–≥</strong>
                </div>
            `;
            
            document.getElementById('workoutTotal').style.display = totalVolume ? 'block' : 'none';
            document.getElementById('totalVolumeNum').textContent = Math.round(totalVolume);
            document.getElementById('saveWorkoutBtn').style.display = totalVolume ? 'block' : 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º MainButton
            tg.MainButton.setParams({text: `üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (${tempWorkout.length} —É–ø—Ä, ${Math.round(totalVolume)}–∫–≥)`});
        }

        function removeExerciseFromWorkout(exerciseId) {
            tempWorkout = tempWorkout.filter(ex => ex.id !== exerciseId);
            updateWorkoutExercises();
        }

        function clearExerciseForm() {
            document.getElementById('exerciseName').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('reps').value = '';
            document.getElementById('sets').value = '';
            document.getElementById('exerciseNotes').value = '';
        }

        function saveCurrentWorkout() {
            if (!tempWorkout.length) {
                tg.showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ!');
                return;
            }

            const workout = {
                name: document.getElementById('workoutName').value || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
                place: document.getElementById('workoutPlace').value || '',
                exercises: [...tempWorkout],
                totalVolume: tempWorkout.reduce((sum, ex) => sum + ex.volume, 0),
                date: new Date().toLocaleString('ru-RU'),
                createdAt: new Date().toISOString()
            };

            workouts.unshift(workout);
            localStorage.setItem('workouts', JSON.stringify(workouts.slice(0, 500))); // –•—Ä–∞–Ω–∏–º –¥–æ 500 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            localStorage.removeItem('currentWorkout');
            
            tempWorkout = [];
            currentWorkout = null;
            
            updateGlobalStats();
            updateHistory();
            tg.MainButton.hide();
            tg.showAlert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            
            clearExerciseForm();
            document.getElementById('workoutExercises').innerHTML = '';
            document.getElementById('saveWorkoutBtn').style.display = 'none';
        }

        function updatePR(exercise) {
            const key = `${exercise.category}_${exercise.name}`;
            if (!prs[key] || exercise.weight > prs[key].weight) {
                prs[key] = {...exercise, date: new Date().toLocaleString('ru-RU')};
                localStorage.setItem('prs', JSON.stringify(prs));
            }
        }

        function loadCurrentWorkout() {
            if (currentWorkout) {
                document.getElementById('currentWorkoutTitle').textContent = `${currentWorkout.name} (${currentWorkout.place})`;
                document.getElementById('currentWorkoutExercises').innerHTML = currentWorkout.exercises.map(ex => `
                    <div class="exercise-item">
                        <div>
                            <h4>${ex.category} - ${ex.name}</h4>
                            <div class="exercise-stats">
                                <span>‚öñÔ∏è ${ex.weight}–∫–≥</span>
                                <span>üî¢ ${ex.reps}√ó${ex.sets}</span>
                                <span>üìä ${Math.round(ex.volume)}–∫–≥</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('currentWorkoutView').style.display = 'block';
            }
        }

        function checkCurrentWorkoutTab() {
            if (currentWorkout) {
                document.getElementById('currentWorkoutView').style.display = 'block';
                document.getElementById('noCurrentWorkout').style.display = 'none';
            } else {
                document.getElementById('currentWorkoutView').style.display = 'none';
                document.getElementById('noCurrentWorkout').style.display = 'block';
            }
        }

        function editCurrentWorkout() {
            editingWorkout = true;
            showTab('new');
            document.getElementById('workoutName').value = currentWorkout.name;
            document.getElementById('workoutPlace').value = currentWorkout.place;
            tempWorkout = [...currentWorkout.exercises];
            updateWorkoutExercises();
        }

        function finalizeCurrentWorkout() {
            localStorage.removeItem('currentWorkout');
            currentWorkout = null;
            checkCurrentWorkoutTab();
            tg.showAlert('‚úÖ –¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        }

        function deleteCurrentWorkout() {
            tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?', () => {
                localStorage.removeItem('currentWorkout');
                currentWorkout = null;
                checkCurrentWorkoutTab();
                tg.showAlert('üóëÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            });
        }

        function updateHistory() {
            const container = document.getElementById('workoutHistory');
            const recentWorkouts = workouts.slice(historyOffset, historyOffset + 10);
            
            container.innerHTML = recentWorkouts.map((workout, index) => `
                <div class="workout-card" onclick="toggleWorkoutDetails(${historyOffset + index})">
                    <div class="workout-header">
                        <div>
                            <div class="workout-date">${workout.date}</div>
                            <div style="color:var(--text-secondary); font-size:14px;">${workout.place || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        </div>
                        <div class="workout-volume">${Math.round(workout.totalVolume).toLocaleString()} –∫–≥</div>
                    </div>
                    <div class="workout-notes">${workout.name}</div>
                    <div class="workout-details" id="details-${historyOffset + index}">
                        ${workout.exercises.map(ex => `
                            <div style="padding:12px 0; border-bottom:1px solid var(--border);">
                                <strong>${ex.category} - ${ex.name}</strong><br>
                                ${ex.weight}–∫–≥ √ó ${ex.reps} √ó ${ex.sets} = ${Math.round(ex.volume)}–∫–≥
                                ${ex.notes ? `<br><small>${ex.notes}</small>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; padding:40px; color:var(--text-secondary);">üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        }

        function toggleWorkoutDetails(index) {
            const details = document.getElementById(`details-${index}`);
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
        }

        function loadMoreHistory() {
            historyOffset += 10;
            updateHistory();
        }

        function clearHistoryConfirm() {
            tg.showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é? (–Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å)', () => {
                workouts = [];
                localStorage.setItem('workouts', '[]');
                historyOffset = 0;
                updateHistory();
                updateGlobalStats();
                tg.showAlert('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
            });
        }

        function updateStats() {
            // –õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã
            const prContainer = document.getElementById('personalRecords');
            const topPRs = Object.values(prs)
                .sort((a, b) => b.weight - a.weight)
                .slice(0, 10);
            
            prContainer.innerHTML = topPRs.map(pr => `
                <div class="pr-item">
                    <div>
                        <div style="font-weight:bold;">${pr.category} - ${pr.name}</div>
                        <div style="color:var(--text-secondary); font-size:14px;">${pr.date}</div>
                    </div>
                    <div>
                        <div style="font-size:24px; font-weight:bold;">${pr.weight}–∫–≥</div>
                        <span class="pr-badge">${pr.reps}√ó${pr.sets}</span>
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; padding:40px; color:var(--text-secondary);">–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const categoryStats = {};
            workouts.forEach(workout => {
                workout.exercises.forEach(ex => {
                    categoryStats[ex.category] = (categoryStats[ex.category] || 0) + ex.volume;
                });
            });

            const categoryContainer = document.getElementById('categoryStats');
            categoryContainer.innerHTML = Object.entries(categoryStats)
                .sort((a, b) => b[1] - a[1])
                .map(([category, volume]) => `
                    <div class="pr-item">
                        <div>${category}</div>
                        <div style="font-weight:bold;">${Math.round(volume).toLocaleString()} –∫–≥</div>
                    </div>
                `).join('');
        }
    </script>
</body>
</html>
